<ion-header class="ion-no-border">
  <!-- Top toolbar -->
  <ion-toolbar>
    <ion-buttons [slot]="selectedLanguage=='en' ? 'start': 'end'">
      <ion-menu-button menu="homeMenu"></ion-menu-button>
    </ion-buttons>

    <ion-title [style.text-align]="selectedLanguage=='en' ? 'start': 'end'">
      {{ 'home' | translate }}
    </ion-title>

    <ion-buttons [slot]="selectedLanguage!=='en' ? 'start': 'end'">
      <ion-button fill="clear" (click)="toggleLayout()" style="color: var(--secondary-color)">
        <ion-icon [name]="isGrid ? 'list' : 'grid'"></ion-icon>
      </ion-button>

      <ion-button fill="clear" style="color: var(--secondary-color)">
        <ion-icon name="heart" style="color: var(--secondary-color) !important"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- ✅ Search toolbar (only when showSearch=true) -->
  <ion-toolbar >
    <ion-searchbar
      #searchbar
      [placeholder]="'search_items' | translate"

      [attr.dir]="selectedLanguage !== 'en' ? 'rtl' : 'ltr'"
      (ionInput)="onSearch($event)"
      mode="ios">
    </ion-searchbar>
  </ion-toolbar>
</ion-header>

<!-- ✅ IMPORTANT: ion-content does NOT scroll -->
<ion-content id="main-content" [scrollY]="false">

  <div class="home-wrapper">

    <!-- ✅ TOP AREA (no scroll) -->
    <div class="home-top">

      <!-- ✅ STORIES (Instagram style) -->
      <div class="stories-wrapper">
        <div class="stories-scroll">

          <!-- Add Story -->
          <div class="story-item" (click)="openAddStoryModal()">
            <div class="story-ring add-story">
              <div class="story-avatar">
                <div class="story-initial">
                  {{ getInitial(currentUserName) }}
                </div>

                <div class="plus-badge">
                  <ion-icon name="add"></ion-icon>
                </div>
              </div>
            </div>

            <div class="story-name">
              {{ selectedLanguage=='en' ? 'Your Story' : 'قصتك' }}
            </div>
          </div>

          <!-- Story List -->
          <div class="story-item" *ngFor="let s of stories" (click)="openStoryViewer(s)">
            <div class="story-ring" [class.seen]="s.seen">
              <div class="story-avatar">
                <!-- if image exists show image -->
                <img [src]="s?.image" alt="Story" *ngIf="s?.image">
                <!-- else show initial -->
                <div class="story-initial" *ngIf="!s?.image">
                  {{ getInitial(s.userName) }}
                </div>
              </div>
            </div>
            <div class="story-name">{{ s.userName }}</div>
          </div>

        </div>
      </div>

      <!-- ✅ Category Chips (no horizontal scroll) -->
      <div class="category-chips-container centered">
        <ion-chip
          *ngFor="let category of categories"
          [color]="category.selected ? 'primary' : 'medium'"
          [outline]="!category.selected"
          (click)="onCategorySelect(category)">

          <ion-icon [name]="category.icon"></ion-icon>
          <ion-label style="margin-top: 4px;">
            {{ selectedLanguage == 'en' ? category.en : category.ar }}
          </ion-label>
        </ion-chip>
      </div>

    </div>

    <!-- ✅ ONLY THIS LIST AREA SCROLLS -->
    <div class="home-list">

      <!-- ✅ Cards -->
      <div class="card-container" [class.grid-view]="isGrid">

        <ion-card *ngFor="let item of filteredItems" mode="ios">

          <!-- ✅ LIST VIEW -->
          <ion-item class="card-item" lines="none" (click)="onCardClick(item)" *ngIf="!isGrid">
            <img
              [src]="(item?.images?.[0] || item?.image || 'assets/images/img/usr.png')"
              [alt]="item?.title"
              class="card-image" />

            <ion-list class="card-details">

              <div
                class="card-title"
                [attr.dir]="(item.title | isArabic) ? 'rtl' : 'ltr'"
                [style.text-align]="(item.title | isArabic) ? 'right' : 'left'">
                {{ item.title }}
              </div>

              <div class="card-info">
                <span class="card-info-item-price">
                  <ion-icon name="pricetag-outline"></ion-icon>
                  <span>{{ item.price }}</span>
                </span>

                <span class="card-info-item">
                  <ion-icon name="time-outline"></ion-icon>
                  <span>{{ item.time | date :'dd MMM yy'}}</span>
                </span>

                <span class="card-info-item" style="justify-content:right">
                  <ion-icon name="location-outline"></ion-icon>

                  <span *ngIf="item?.location">
                    {{ (+item?.location?.lat) | number:'1.2-2' }},
                    {{ (+item?.location?.lng) | number:'1.2-2' }}
                  </span>

                  <span *ngIf="!item?.location">N/A</span>
                </span>
              </div>

              <div class="card-info">
                <span class="card-info-item" style="justify-content:left; color: var(--primary-color);">
                  <ion-icon name="chatbubbles" *ngIf="item?.comments?.length > 0"></ion-icon>
                  <span *ngIf="item?.comments?.length > 0">{{ item?.comments?.length }}</span>
                </span>

                <span class="card-info-item user-initial" style="justify-content:right">
                  <span class="initial-circle">{{ item.user?.name?.charAt(0) }}</span>
                  <span>{{ item.user?.name }}</span>
                </span>
              </div>

            </ion-list>
          </ion-item>

          <!-- ✅ GRID VIEW -->
          <ion-item class="card-item" lines="none" (click)="onCardClick(item)" *ngIf="isGrid">
            <div class="grid-item-inner">
              <img
                [src]="(item?.images?.[0] || item?.image || 'assets/images/img/usr.png')"
                [alt]="item?.title"
                class="card-image" />

              <ion-list class="card-details">

                <div
                  class="card-title"
                  [attr.dir]="(item.title | isArabic) ? 'rtl' : 'ltr'"
                  [style.text-align]="(item.title | isArabic) ? 'right' : 'left'">
                  {{ item.title }}
                </div>

                <div class="card-info">
                  <span class="card-info-item-price">
                    <ion-icon name="pricetag-outline"></ion-icon>
                    <span>{{ item.price }}</span>
                  </span>

                  <span class="card-info-item">
                    <ion-icon name="time-outline"></ion-icon>
                    <span>{{ item.time | date :'dd MMM yy'}}</span>
                  </span>

                  <span class="card-info-item" style="justify-content:right">
                    <ion-icon name="location-outline"></ion-icon>

                    <span *ngIf="item?.location">
                      {{ (+item?.location?.lat) | number:'1.2-2' }},
                      {{ (+item?.location?.lng) | number:'1.2-2' }}
                    </span>

                    <span *ngIf="!item?.location">N/A</span>
                  </span>
                </div>

                <div class="card-info">
                  <span class="card-info-item" style="justify-content:left; color: var(--primary-color);">
                    <ion-icon name="chatbubbles" *ngIf="item?.comments?.length > 0"></ion-icon>
                    <span *ngIf="item?.comments?.length > 0">{{ item?.comments?.length }}</span>
                  </span>

                  <span class="card-info-item user-initial" style="justify-content:right">
                    <span class="initial-circle">{{ item.user?.name?.charAt(0) }}</span>
                    <span>{{ item.user?.name }}</span>
                  </span>
                </div>

              </ion-list>
            </div>
          </ion-item>

        </ion-card>

        <!-- Empty State -->
        <div *ngIf="items.length === 0" class="empty-state">
          <ion-icon name="basket-outline" size="large"></ion-icon>
          <p>{{ 'no_items' | translate }}</p>
        </div>

      </div>
    </div>
  </div>

  <!-- ✅ Add Story Modal -->
  <ion-modal [isOpen]="isAddStoryOpen" (didDismiss)="closeAddStoryModal()" mode="ios">
    <ng-template>
      <ion-header class="ion-no-border">
        <ion-toolbar>
          <ion-title>{{ selectedLanguage=='en' ? 'Add Story' : 'إضافة قصة' }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeAddStoryModal()">
              {{ selectedLanguage=='en' ? 'Close' : 'إغلاق' }}
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <ion-item>
          <ion-label position="stacked">
            {{ selectedLanguage=='en' ? 'Story Image URL' : 'رابط صورة القصة' }}
          </ion-label>
          <ion-input [(ngModel)]="newStoryImage" placeholder="https://..."></ion-input>
        </ion-item>

        <ion-item class="mt12">
          <ion-label position="stacked">
            {{ selectedLanguage=='en' ? 'Caption (optional)' : 'وصف (اختياري)' }}
          </ion-label>
          <ion-textarea [(ngModel)]="newStoryCaption" autoGrow="true"></ion-textarea>
        </ion-item>

        <ion-button expand="block" class="mt16" (click)="addStory()">
          {{ selectedLanguage=='en' ? 'Post Story' : 'نشر القصة' }}
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- ✅ Story Viewer Modal -->
  <ion-modal [isOpen]="isStoryViewerOpen" (didDismiss)="closeStoryViewer()" mode="ios">
    <ng-template>
      <ion-header class="ion-no-border">
        <ion-toolbar>
          <ion-title>{{ activeStory?.userName }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeStoryViewer()"
              style="--background: var(--primary-color); --color: var(--secondary-color);">
              {{ selectedLanguage=='en' ? 'Close' : 'إغلاق' }}
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="story-viewer">
        <div class="story-viewer-inner">
          <img [src]="activeStory?.image" class="story-full-image" />
          <div class="story-caption" *ngIf="activeStory?.caption">
            {{ activeStory?.caption }}
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
